{% extends "base.html" %}

{% block title %}Contact Messages - Admin Panel{% endblock %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1 style="margin-bottom: 0.5rem; font-size: 2rem;">Contact Messages</h1>
            <p style="color: var(--text-secondary);">
                View and manage messages sent through the contact form
            </p>
        </div>
        <div>
            {% if unread_count > 0 %}
            <span class="badge" style="background-color: #ef4444; color: white; padding: 0.3rem 1rem; border-radius: 20px; margin-right: 1rem;">
                <i class="fas fa-envelope"></i> {{ unread_count }} Unread
            </span>
            {% endif %}
            <a href="{{ url_for('export_messages') }}" class="btn">
                <i class="fas fa-download"></i> Export CSV
            </a>
        </div>
    </div>
</div>

<!-- Message Statistics -->
<div class="grid grid-4" style="margin-bottom: 2rem;">
    <div class="card" style="text-align: center;">
        <i class="fas fa-envelope" style="font-size: 2.5rem; color: var(--accent); margin-bottom: 1rem;"></i>
        <h3 style="font-size: 2rem; margin-bottom: 0.5rem;">{{ total_count }}</h3>
        <p>Total Messages</p>
    </div>
    
    <div class="card" style="text-align: center;">
        <i class="fas fa-envelope-open" style="font-size: 2.5rem; color: #10b981; margin-bottom: 1rem;"></i>
        <h3 style="font-size: 2rem; margin-bottom: 0.5rem;">{{ total_count - unread_count }}</h3>
        <p>Read</p>
    </div>
    
    <div class="card" style="text-align: center;">
        <i class="fas fa-envelope" style="font-size: 2.5rem; color: #ef4444; margin-bottom: 1rem;"></i>
        <h3 style="font-size: 2rem; margin-bottom: 0.5rem;">{{ unread_count }}</h3>
        <p>Unread</p>
    </div>
    
    <div class="card" style="text-align: center;">
        <i class="fas fa-clock" style="font-size: 2.5rem; color: #3b82f6; margin-bottom: 1rem;"></i>
        <h3 style="font-size: 2rem; margin-bottom: 0.5rem;">24h</h3>
        <p>Response Time</p>
    </div>
</div>

{% if messages %}
<div class="card" style="overflow-x: auto;">
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="border-bottom: 2px solid var(--border);">
                <th style="text-align: left; padding: 1rem; width: 50px;">#</th>
                <th style="text-align: left; padding: 1rem;">From</th>
                <th style="text-align: left; padding: 1rem;">Subject</th>
                <th style="text-align: left; padding: 1rem;">Message Preview</th>
                <th style="text-align: left; padding: 1rem;">Date & Time</th>
                <th style="text-align: left; padding: 1rem;">Status</th>
                <th style="text-align: left; padding: 1rem;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for msg in messages %}
            <tr style="border-bottom: 1px solid var(--border); {% if not msg.is_read %}background-color: #fef2f2;{% endif %}">
                <td style="padding: 1rem; font-weight: {% if not msg.is_read %}bold{% endif %};">{{ loop.index }}</td>
                <td style="padding: 1rem;">
                    <strong>{{ msg.name }}</strong><br>
                    <small style="color: var(--text-secondary);">{{ msg.email }}</small>
                </td>
                <td style="padding: 1rem; font-weight: {% if not msg.is_read %}bold{% endif %};">{{ msg.subject }}</td>
                <td style="padding: 1rem;">
                    <div style="max-height: 60px; overflow: hidden; text-overflow: ellipsis;">
                        {{ msg.message|truncate(100) }}
                    </div>
                </td>
                <td style="padding: 1rem;">
                    <small>{{ msg.submitted_at.strftime('%Y-%m-%d') }}</small><br>
                    <small style="color: var(--text-secondary);">{{ msg.submitted_at.strftime('%H:%M:%S') }}</small>
                </td>
                <td style="padding: 1rem;">
                    {% if msg.is_read %}
                    <span style="background-color: #10b981; color: white; padding: 0.3rem 0.8rem; border-radius: 3px; font-size: 0.8rem;">
                        <i class="fas fa-check"></i> Read
                    </span>
                    {% else %}
                    <span style="background-color: #ef4444; color: white; padding: 0.3rem 0.8rem; border-radius: 3px; font-size: 0.8rem;">
                        <i class="fas fa-envelope"></i> New
                    </span>
                    {% endif %}
                </td>
                <td style="padding: 1rem;">
                    <div style="display: flex; gap: 0.3rem; flex-wrap: wrap;">
                        <!-- View Button -->
                        <a href="{{ url_for('view_message', message_id=msg.id) }}" 
                           class="btn" style="padding: 0.3rem 0.8rem; font-size: 0.9rem;">
                            <i class="fas fa-eye"></i> View
                        </a>
                        
                        <!-- Mark as Read/Unread -->
                        {% if not msg.is_read %}
                        <a href="{{ url_for('mark_message_read', message_id=msg.id) }}" 
                           class="btn btn-secondary" style="padding: 0.3rem 0.8rem; font-size: 0.9rem;">
                            <i class="fas fa-check"></i> Read
                        </a>
                        {% else %}
                        <a href="{{ url_for('mark_message_unread', message_id=msg.id) }}" 
                           class="btn btn-secondary" style="padding: 0.3rem 0.8rem; font-size: 0.9rem;">
                            <i class="fas fa-envelope"></i> Unread
                        </a>
                        {% endif %}
                        
                        <!-- Delete Button -->
                        <a href="{{ url_for('delete_message', message_id=msg.id) }}" 
                           class="btn btn-secondary" 
                           style="padding: 0.3rem 0.8rem; font-size: 0.9rem; background-color: #fee2e2; color: #991b1b;"
                           onclick="return confirm('Are you sure you want to delete this message?')">
                            <i class="fas fa-trash"></i>
                        </a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination (if needed) -->
{% if messages|length > 20 %}
<div style="display: flex; justify-content: center; margin-top: 2rem;">
    <div style="display: flex; gap: 0.5rem;">
        <button class="btn btn-secondary" style="padding: 0.5rem 1rem;">
            <i class="fas fa-chevron-left"></i> Previous
        </button>
        <button class="btn" style="padding: 0.5rem 1rem;">1</button>
        <button class="btn btn-secondary" style="padding: 0.5rem 1rem;">2</button>
        <button class="btn btn-secondary" style="padding: 0.5rem 1rem;">3</button>
        <button class="btn btn-secondary" style="padding: 0.5rem 1rem;">
            Next <i class="fas fa-chevron-right"></i>
        </button>
    </div>
</div>
{% endif %}

{% else %}
<div class="card" style="text-align: center; padding: 3rem;">
    <i class="fas fa-inbox" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 1rem;"></i>
    <h3>No Messages Yet</h3>
    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
        No contact messages have been received yet.
    </p>
</div>
{% endif %}

<!-- Quick Actions -->
<div style="display: flex; gap: 1rem; margin-top: 2rem;">
    <a href="{{ url_for('admin_panel') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
    </a>
    
    {% if unread_count > 0 %}
    <a href="#" class="btn" onclick="markAllAsRead()">
        <i class="fas fa-check-double"></i> Mark All as Read
    </a>
    {% endif %}
    
    <a href="{{ url_for('export_messages') }}" class="btn">
        <i class="fas fa-download"></i> Export All Messages
    </a>
</div>

<script>
function markAllAsRead() {
    if (confirm('Mark all messages as read?')) {
        // This would require a separate endpoint to mark all as read
        alert('This feature requires backend implementation. Currently, mark each message individually.');
    }
}
</script>

<style>
tr:hover {
    background-color: var(--bg-tertiary) !important;
}
</style>
{% endblock %}
